


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A curated list of awesome Python frameworks, libraries and software">
      
      
        <link rel="canonical" href="https://www.inetsix.net/Arista%20AVD/ansible-avd-config/">
      
      
        <meta name="author" content="TiTom73">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.1.1">
    
    
      
        <title>Arista AVD Configuration overview - Inetsix doc repository</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a676eddb.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>body,input{font-family:"Ubuntu",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#arista-avd-configuration-overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://www.inetsix.net" title="Inetsix doc repository" class="md-header-nav__button md-logo" aria-label="Inetsix doc repository">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Inetsix doc repository
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Arista AVD Configuration overview
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/inetsix/blog/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://www.inetsix.net" title="Inetsix doc repository" class="md-nav__button md-logo" aria-label="Inetsix doc repository">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Inetsix doc repository
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/inetsix/blog/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Inetsix" class="md-nav__link">
      Inetsix
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../gh-repos/" title="Github Repositories" class="md-nav__link">
      Github Repositories
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../tips/" title="Tips & Tricks" class="md-nav__link">
      Tips & Tricks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../yaml-jinja/" title="YAML Structures in Jinja2" class="md-nav__link">
      YAML Structures in Jinja2
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Arista AVD
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Arista AVD" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Arista AVD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Arista AVD Configuration overview
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Arista AVD Configuration overview" class="md-nav__link md-nav__link--active">
      Arista AVD Configuration overview
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inventory-file" class="md-nav__link">
    Inventory file.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#avd-variables" class="md-nav__link">
    AVD Variables
  </a>
  
    <nav class="md-nav" aria-label="AVD Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generic-fabric-information" class="md-nav__link">
    Generic Fabric Information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-fabric-topology" class="md-nav__link">
    Configure Fabric topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-device-type" class="md-nav__link">
    Configure device type
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-vnivlan-across-the-fabric" class="md-nav__link">
    Configure VNI/VLAN across the Fabric.
  </a>
  
    <nav class="md-nav" aria-label="Configure VNI/VLAN across the Fabric.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#l2-services" class="md-nav__link">
    L2 Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#symetric-irb-model" class="md-nav__link">
    Symetric IRB model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-downlinks" class="md-nav__link">
    Configure downlinks
  </a>
  
    <nav class="md-nav" aria-label="Configure downlinks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-home-server" class="md-nav__link">
    Single home server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-connected-to-mlag" class="md-nav__link">
    Server connected to MLAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-tasks-for-avd" class="md-nav__link">
    Configure tasks for AVD
  </a>
  
    <nav class="md-nav" aria-label="Configure tasks for AVD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-directory-structure" class="md-nav__link">
    Create directory structure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transform-evpn-datamodel-to-device-data-model" class="md-nav__link">
    Transform EVPN datamodel to device data model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-device-configuration-and-documentation" class="md-nav__link">
    Generate device configuration and documentation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible-avd-eve/" title="Arista AVD on EVE-NG" class="md-nav__link">
      Arista AVD on EVE-NG
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      How to
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="How to" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        How to
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../how-to/ci-to-start-docker-and-validate-code/" title="Continuous Intgration with Docker interactions" class="md-nav__link">
      Continuous Intgration with Docker interactions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../how-to/docker-ansible/" title="Ansible using docker" class="md-nav__link">
      Ansible using docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../how-to/virtual-env-python/" title="VirtualEnv Wrapper" class="md-nav__link">
      VirtualEnv Wrapper
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inventory-file" class="md-nav__link">
    Inventory file.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#avd-variables" class="md-nav__link">
    AVD Variables
  </a>
  
    <nav class="md-nav" aria-label="AVD Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generic-fabric-information" class="md-nav__link">
    Generic Fabric Information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-fabric-topology" class="md-nav__link">
    Configure Fabric topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-device-type" class="md-nav__link">
    Configure device type
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-vnivlan-across-the-fabric" class="md-nav__link">
    Configure VNI/VLAN across the Fabric.
  </a>
  
    <nav class="md-nav" aria-label="Configure VNI/VLAN across the Fabric.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#l2-services" class="md-nav__link">
    L2 Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#symetric-irb-model" class="md-nav__link">
    Symetric IRB model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-downlinks" class="md-nav__link">
    Configure downlinks
  </a>
  
    <nav class="md-nav" aria-label="Configure downlinks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-home-server" class="md-nav__link">
    Single home server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-connected-to-mlag" class="md-nav__link">
    Server connected to MLAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-tasks-for-avd" class="md-nav__link">
    Configure tasks for AVD
  </a>
  
    <nav class="md-nav" aria-label="Configure tasks for AVD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-directory-structure" class="md-nav__link">
    Create directory structure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transform-evpn-datamodel-to-device-data-model" class="md-nav__link">
    Transform EVPN datamodel to device data model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-device-configuration-and-documentation" class="md-nav__link">
    Generate device configuration and documentation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/inetsix/blog/edit/master/docs/Arista AVD/ansible-avd-config.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="arista-avd-configuration-overview">Arista AVD Configuration overview<a class="headerlink" href="#arista-avd-configuration-overview" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p><a href="https://www.arista.com/">Arista Networks</a> supports Ansible for managing devices running the EOS operating system natively through eapi or CloudVision Portal (CVP). This collection includes a set of ansible roles and modules to help kick-start your automation with Arista. The various roles and templates provided are designed to be customized and extended to your needs!</p>
<p><img alt="Arista Validated Design" src="docs/medias/../../medias/ansible-avd-overview.gif" /></p>
<p>In this post, we will go through all configuration steps to generate <a href="https://www.arista.com/custom_data/downloads/?f=/support/download/DesignGuides/EVPN_Deployment_Guide.pdf">EVPN/VXLAN configuration</a> for EOS devices. Because some files might be very verbose, we demo repository is available to get complete content of all files: <a href="https://github.com/inetsix/demo-avd-evpn-eve-ng">inetsix/demo-avd-evpn-eve-ng</a>. Idea is not to cover all EVPN/VXLAN feaures, but go through <strong>AVD</strong> to see how to implement.</p>
<p>You can organize your work in many different way, but a structure I find useful is something like this:</p>
<ul>
<li>A folder for all your inventories with one sub-folder per inventory. An inventory folder contains all your variables for a given environment like <code>host_vars</code>, <code>group_vars</code>, <code>inventory.yml</code></li>
<li>A folder to store all playbooks. So it is easy to reuse playbooks whatever the inventory is (if you use a coherent syntax)</li>
<li>ansible.cfg at the root of this repository</li>
</ul>
<div class="highlight"><pre><span></span><code>$ tree -L <span class="m">3</span> -d
.
├── inventories
│   ├── inetsix-cvp
│   │   ├── group_vars
│   │   ├── host_vars
│   │   └── media
│   └── inetsix-eapi
│       ├── group_vars
│       └── medias
└── playbooks
</code></pre></div>

<p>From there, you can run ansible playbooks with following syntax (as an example) :</p>
<div class="highlight"><pre><span></span><code>$ ansible-playbook playbooks/my-playbook -i inventories/inetsix-eapi
</code></pre></div>

<p>To support this post, we will use the following topology running on EVE-NG server:</p>
<p><img alt="Lab Topology" src="docs/../medias/ansible-avd-lab-topology.png" /></p>
<h2 id="inventory-file">Inventory file.<a class="headerlink" href="#inventory-file" title="Permanent link">&para;</a></h2>
<p>In our inventory, let&rsquo;s list our devices:</p>
<ul>
<li><code>AVD2_FABRIC</code> represents complete fabric topology we are going to configure with AVD.</li>
<li><code>AVD2_SPINES</code> is a group where all spine devices belongs.</li>
<li><code>AVD2_L3LEAFS</code>: is a group to locate all VTEP devices (LEAFs running EVPN/VXLAN). Part of this group, we create one sub-group for every LEAF (single or MLAG) as highlighted below.</li>
<li><code>AVD_LEAF1</code> represent LEAF for POD01 and is for an MLAG pair.</li>
<li><code>AVD_LEAF3</code> represent a single LEAF outside of MLAG.</li>
<li><code>AVD2_L2LEAFS</code> represent Aggregation layer in our current design. This layer is optional, but in our design it is in place. It works like for <code>AVD2_L3LEAFS</code> group.</li>
<li><code>AVD2_TENANTS_NETWORKS</code> is a special group housing 2 groups already configured: <code>AVD2_L{2|3}LEAFS</code>. This group will configure VNI/VLAN across the fabric, so we want to make leafs part of the configuration.</li>
<li><code>AVD2_SERVERS</code> as similar behavior to previous group. Its goal is to configure downlinks to compute nodes.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># vim inventories/inetsix-eapi/inventory.yml</span>
<span class="nn">---</span>
<span class="nt">AVD2</span><span class="p">:</span>
  <span class="nt">children</span><span class="p">:</span>
    <span class="nt">AVD2_FABRIC</span><span class="p">:</span>
      <span class="nt">children</span><span class="p">:</span>
        <span class="nt">AVD2_SPINES</span><span class="p">:</span>
          <span class="nt">hosts</span><span class="p">:</span>
            <span class="nt">AVD2-SPINE1</span><span class="p">:</span>
              <span class="nt">ansible_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8001</span>
<span class="p p-Indicator">[</span><span class="nv">... output truncated ...</span><span class="p p-Indicator">]</span>
        <span class="nt">AVD2_L3LEAFS</span><span class="p">:</span>
          <span class="nt">children</span><span class="p">:</span>
            <span class="nt">AVD2_LEAF1</span><span class="p">:</span>
              <span class="nt">hosts</span><span class="p">:</span>
                <span class="nt">AVD2-LEAF1A</span><span class="p">:</span>
                  <span class="nt">ansible_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8011</span>
                <span class="nt">AVD2-LEAF1B</span><span class="p">:</span>
                  <span class="nt">ansible_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8012</span>
            <span class="nt">AVD2_LEAF3</span><span class="p">:</span>
              <span class="nt">hosts</span><span class="p">:</span>
                <span class="nt">AVD2-LEAF3A</span><span class="p">:</span>
                  <span class="nt">ansible_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8017</span>
<span class="p p-Indicator">[</span><span class="nv">... output truncated ...</span><span class="p p-Indicator">]</span>
        <span class="nt">AVD2_L2LEAFS</span><span class="p">:</span>
          <span class="nt">children</span><span class="p">:</span>
            <span class="nt">AVD2_L2LEAF1</span><span class="p">:</span>
              <span class="nt">hosts</span><span class="p">:</span>
                <span class="nt">AVD2-AGG01</span><span class="p">:</span>
                  <span class="nt">ansible_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8021</span>
<span class="p p-Indicator">[</span><span class="nv">... output truncated ...</span><span class="p p-Indicator">]</span>
    <span class="nt">AVD2_TENANTS_NETWORKS</span><span class="p">:</span>
      <span class="nt">children</span><span class="p">:</span>
        <span class="nt">AVD2_L3LEAFS</span><span class="p">:</span>
        <span class="nt">AVD2_L2LEAFS</span><span class="p">:</span>
    <span class="nt">AVD2_SERVERS</span><span class="p">:</span>
      <span class="nt">children</span><span class="p">:</span>
        <span class="nt">AVD2_L3LEAFS</span><span class="p">:</span>
        <span class="nt">AVD2_L2LEAFS</span><span class="p">:</span>
</code></pre></div>

<p>In this file, you can also define management address of all devices. Because in this lab we use Jumphost, we will configure this address in the next section, but at least we configured on which port we will connect to eAPI using <code>ansible_port</code> variable.</p>
<h2 id="avd-variables">AVD Variables<a class="headerlink" href="#avd-variables" title="Permanent link">&para;</a></h2>
<p>Based on inventory we did in the previous section, it is time to create <code>group_vars</code>.</p>
<h3 id="generic-fabric-information">Generic Fabric Information<a class="headerlink" href="#generic-fabric-information" title="Permanent link">&para;</a></h3>
<p>All the documentation is available here, but below is a short example. All this information will be configured on all devices.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># vim inventories/inetsix-eapi/group_vars/AVD2.yml</span>
<span class="nn">---</span>
<span class="c1"># local users</span>
<span class="nt">local_users</span><span class="p">:</span>
  <span class="nt">admin</span><span class="p">:</span>
    <span class="nt">privilege</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">15</span>
    <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">network-admin</span>
    <span class="nt">sha512_password</span><span class="p">:</span> <span class="s">&quot;...&quot;</span>

  <span class="nt">demo</span><span class="p">:</span>
    <span class="nt">privilege</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">15</span>
    <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">network-admin</span>
    <span class="nt">sha512_password</span><span class="p">:</span> <span class="s">&quot;...&quot;</span>

<span class="c1"># OOB Management network default gateway.</span>
<span class="nt">mgmt_gateway</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.73.254.253</span>
<span class="nt">mgmt_destination_networks</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">10.255.2.0/24</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">10.255.3.0/24</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0/0</span>

<span class="c1"># dns servers.</span>
<span class="nt">name_servers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1.1.1.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8.8.8.8</span>

<span class="c1"># NTP Servers IP or DNS name, first NTP server will be prefered, and sourced from Managment VRF</span>
<span class="nt">ntp_servers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">uk.pool.ntp.org</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">fr.pool.ntp.org</span>
</code></pre></div>

<h3 id="configure-fabric-topology">Configure Fabric topology<a class="headerlink" href="#configure-fabric-topology" title="Permanent link">&para;</a></h3>
<p>Fabric topology is configured in <a href="https://github.com/inetsix/demo-avd-evpn-eve-ng/blob/master/inventories/inetsix-eapi/group_vars/AVD2_FABRIC.yml"><code>inventories/inetsix-eapi/group_vars/AVD2_FABRIC.yml</code></a> which is file that covers <code>AVD2_FABRIC</code> group we defined in <a href="#inventory-file">inventory</a>. This file contains all the base information to create initial configuration:</p>
<p>You can also refer to <a href="https://github.com/aristanetworks/ansible-avd/blob/devel/ansible_collections/arista/avd/roles/eos_l3ls_evpn/README.md#fabric-topology-variables"><strong>Arista Validated Design</strong> documentation</a> to get a description of every single option available.</p>
<ul>
<li>Subnet to use for underlay, loopback and vtep:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Point to Point Network Summary range, assigned as /31 for each</span>
<span class="c1"># uplink interfaces</span>
<span class="c1"># Assign range larger then total [spines * total potential leafs * 2]</span>
<span class="nt">underlay_p2p_network_summary</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">172.31.255.0/24</span>

<span class="c1"># IP address range for evpn loopback for all switches in fabric,</span>
<span class="c1"># assigned as /32s</span>
<span class="c1"># Assign range larger then total spines + total leafs switches</span>
<span class="nt">overlay_loopback_network_summary</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.255.0/24</span>

<span class="c1"># VTEP VXLAN Tunnel source loopback IP for leaf switches, assigned in /32s</span>
<span class="c1"># Assign range larger then total leaf switches</span>
<span class="nt">vtep_loopback_network_summary</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.254.0/24</span>
</code></pre></div>

<ul>
<li>MLAG IP information</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># mlag pair IP assignment - assign blocks - Assign range larger then</span>
<span class="c1"># total spines + total leafs switches</span>
<span class="nt">mlag_ips</span><span class="p">:</span>
  <span class="nt">leaf_peer_l3</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.255.251.0/24</span>
  <span class="nt">mlag_peer</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.255.252.0/24</span>
</code></pre></div>

<p>Then, you have to describe devices for each role. Don&rsquo;t forget to set management IP here.</p>
<ul>
<li>Spine devices</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Spine Switches</span>
<span class="nt">spine</span><span class="p">:</span>
  <span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vEOS-LAB</span>
  <span class="nt">bgp_as</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65001</span>
  <span class="c1"># defines the range of acceptable remote ASNs from leaf switches</span>
  <span class="nt">leaf_as_range</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65101-65132</span>
  <span class="nt">nodes</span><span class="p">:</span>
    <span class="nt">AVD2-SPINE1</span><span class="p">:</span>
      <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">mgmt_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.73.254.1/24</span>
    <span class="nt">AVD2-SPINE2</span><span class="p">:</span>
      <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
      <span class="nt">mgmt_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.73.254.2/24</span>
</code></pre></div>

<ul>
<li>VTEP or L3LEAF devices</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">l3leaf</span><span class="p">:</span>
  <span class="nt">defaults</span><span class="p">:</span>
    <span class="nt">virtual_router_mac_address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">00:1c:73:00:dc:01</span>
    <span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vEOS-LAB</span>
    <span class="nt">bgp_as</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65100</span>
    <span class="nt">spines</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">AVD2-SPINE1</span><span class="p p-Indicator">,</span> <span class="nv">AVD2-SPINE2</span><span class="p p-Indicator">]</span>
    <span class="nt">uplink_to_spine_interfaces</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Ethernet1</span><span class="p p-Indicator">,</span> <span class="nv">Ethernet2</span><span class="p p-Indicator">]</span>
    <span class="nt">mlag_interfaces</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Ethernet3</span><span class="p p-Indicator">,</span> <span class="nv">Ethernet4</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">[</span><span class="nv">... output truncated ...</span><span class="p p-Indicator">]</span>
  <span class="nt">node_groups</span><span class="p">:</span>
    <span class="nt">AVD2_LEAF1</span><span class="p">:</span>
      <span class="nt">bgp_as</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65101</span>
      <span class="nt">nodes</span><span class="p">:</span>
        <span class="nt">AVD2-LEAF1A</span><span class="p">:</span>
          <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="nt">mgmt_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.73.254.11/24</span>
          <span class="c1"># Interface configured on SPINES to connect to this leaf</span>
          <span class="nt">spine_interfaces</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Ethernet1</span><span class="p p-Indicator">,</span> <span class="nv">Ethernet1</span><span class="p p-Indicator">]</span>
        <span class="nt">AVD2-LEAF1B</span><span class="p">:</span>
          <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
          <span class="nt">mgmt_ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.73.254.12/24</span>
          <span class="c1"># Interface configured on SPINES to connect to this leaf</span>
          <span class="nt">spine_interfaces</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Ethernet2</span><span class="p p-Indicator">,</span> <span class="nv">Ethernet2</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">[</span><span class="nv">... output truncated ...</span><span class="p p-Indicator">]</span>
</code></pre></div>

<ul>
<li>Aggregation switches: Configuration process is similar to L3LEAFS.</li>
</ul>
<p>Complete documentation of all available variables is available in <a href="https://github.com/aristanetworks/ansible-avd/blob/devel/ansible_collections/arista/avd/roles/eos_l3ls_evpn/README.md#fabric-topology-variables"><strong>Arista Validated Design</strong> documentation</a>. You can also look at <a href="https://github.com/inetsix/demo-avd-evpn-eve-ng/blob/3a461e0ce25afb25d4e51f620bafd324018c1189/inventories/inetsix-eapi/group_vars/AVD2_FABRIC.yml">variables part of the demo repo</a> we are using for this post.</p>
<blockquote>
<p>As you can see here, if you want to change name in your inventory, you have to edit filename in group_vars to reflect that change as well as content of this fabric file.</p>
</blockquote>
<h3 id="configure-device-type">Configure device type<a class="headerlink" href="#configure-device-type" title="Permanent link">&para;</a></h3>
<p>In each variable file related to a type of devices, we have to instruct AVD what is the role of our devices.</p>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">spine</span>     <span class="c1"># Must be either spine|l3leaf|l2leaf</span>
</code></pre></div>

<h3 id="configure-vnivlan-across-the-fabric">Configure VNI/VLAN across the Fabric.<a class="headerlink" href="#configure-vnivlan-across-the-fabric" title="Permanent link">&para;</a></h3>
<p>AVD supports mechanism to create VLANs and VNIs and enable traffic forwarding in your overlay. In current version (<code>v1.0.2</code>), only following design listed below are supported:</p>
<ul>
<li>L2 VLANs</li>
<li>Symetric IRB model</li>
</ul>
<p>Model defines a set of tenants (user&rsquo;s defined) where you can configure VRF or <code>l2vlans</code> or a mix of them. Let&rsquo;s take a look at how we configure such services.</p>
<p>All these configurations shall be configured in file <a href="https://github.com/inetsix/demo-avd-evpn-eve-ng/blob/3a461e0ce25afb25d4e51f620bafd324018c1189/inventories/inetsix-eapi/group_vars/AVD2_L3LEAFS.yml"><code>AVD2_TENANTS_NETWORKS.yml</code></a></p>
<h4 id="l2-services">L2 Services<a class="headerlink" href="#l2-services" title="Permanent link">&para;</a></h4>
<p>Configure a pure L2 service using <code>EVPN route type 2</code> only:</p>
<p><div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">tenants</span><span class="p">:</span>
  <span class="c1"># Tenant B Specific Information - Pure L2 tenant</span>
  <span class="nt">Tenant_B</span><span class="p">:</span>
    <span class="nt">mac_vrf_vni_base</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20000</span>
    <span class="nt">l2vlans</span><span class="p">:</span>
      <span class="nt">201</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;B-ELAN-201&#39;</span>
        <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">DC1</span><span class="p p-Indicator">]</span>
</code></pre></div>
Tag option allows to configure VLAN only on a subset of the fabric: all devices with this tag will be configured with this vlan. To configure device <code>TAGS</code> and <code>TENANTS</code> options, go to <a href="https://github.com/aristanetworks/ansible-avd/blob/devel/ansible_collections/arista/avd/roles/eos_l3ls_evpn/README.md#fabric-topology-variables"><strong>Arista Validated Design</strong> documentation</a></p>
<p>In this configuration, VLAN will be created with a tag of <code>201</code> and its attached VNI will be configured with <code>20201</code></p>
<div class="highlight"><pre><span></span><code>AVD2-LEAF1A#show vlan 201
VLAN  Name                             Status    Ports
----- -------------------------------- --------- -------------------------------
201   B-ELAN-201                       active    Po3, Po5, Vx1


AVD2-LEAF1A#show bgp evpn vni 20201
BGP routing table information for VRF default
Router identifier 192.168.255.3, local AS number 65101
Route status codes: s - suppressed, * - valid, &gt; - active, # - not installed, E - ECMP head, e - ECMP
                    S - Stale, c - Contributing to ECMP, b - backup
                    % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

         Network                Next Hop              Metric  LocPref Weight  Path
 * &gt;     RD: 192.168.255.3:20201 mac-ip 20201 5001.0011.0000
                                -                     -       -       0       i
 * &gt;     RD: 192.168.255.3:20201 imet 20201 192.168.254.3
                                -                     -       -       0       i
 * &gt;Ec   RD: 192.168.255.5:20201 imet 20201 192.168.254.5
                                192.168.254.5         -       100     0       65001 65102 i
[... output truncated ...]
</code></pre></div>

<h4 id="symetric-irb-model">Symetric IRB model<a class="headerlink" href="#symetric-irb-model" title="Permanent link">&para;</a></h4>
<p>Configure IRB symetric model, use following structure:</p>
<div class="highlight"><pre><span></span><code><span class="nt">tenants</span><span class="p">:</span>
  <span class="c1"># Tenant A Specific Information - VRFs / VLANs</span>
  <span class="nt">Tenant_A</span><span class="p">:</span>
    <span class="nt">mac_vrf_vni_base</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10000</span>
    <span class="nt">vrfs</span><span class="p">:</span>
      <span class="nt">TENANT_A_PROJECT01</span><span class="p">:</span>
        <span class="nt">vrf_vni</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">11</span>
        <span class="nt">svis</span><span class="p">:</span>
          <span class="nt">110</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;PR01-DMZ&#39;</span>
            <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">DC1</span><span class="p p-Indicator">]</span>
            <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
            <span class="nt">ip_address_virtual</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.1.10.254/24</span>
          <span class="nt">111</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;PR01-TRUST&#39;</span>
            <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">POD02</span><span class="p p-Indicator">]</span>
            <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
            <span class="nt">ip_address_virtual</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.1.11.254/24</span>
      <span class="nt">TENANT_A_PROJECT02</span><span class="p">:</span>
        <span class="nt">vrf_vni</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">12</span>
        <span class="nt">vtep_diagnostic</span><span class="p">:</span>
          <span class="nt">loopback</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
          <span class="nt">loopback_ip_range</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.1.255.0/24</span>
        <span class="nt">svis</span><span class="p">:</span>
          <span class="nt">112</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;PR02-DMZ-GREEN&#39;</span>
            <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">POD01</span><span class="p p-Indicator">]</span>
            <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
            <span class="nt">ip_address_virtual</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.1.12.254/24</span>
</code></pre></div>

<p>Example will create 2 VRFs :</p>
<ul>
<li><code>TENANT_A_PROJECT01</code></li>
<li><code>TENANT_A_PROJECT02</code></li>
</ul>
<p>In <code>TENANT_A_PROJECT01</code>, 2 subnets are created and deployed on devices matching TAGS <code>DC1</code> or <code>POD02</code>:</p>
<ul>
<li><code>10.1.10.0/24</code> with vlan <code>110</code> and vni <code>10110</code></li>
<li><code>10.1.11.0/24</code> with vlan <code>111</code> and vni <code>10111</code></li>
</ul>
<p>In case you deployed this VRF on a MLAG VTEP, an additional vlan is created to allow L3 synchronization within VRF. This vlan is automatically generated with this algorithm:</p>
<div class="highlight"><pre><span></span><code>{{ mlag_ibgp_peering_vrfs.base_vlan + (tenants[tenant].vrfs[vrf].vrf_vni - 1) }}
</code></pre></div>

<p>In addition to that, each EOS devices will allocate a dynamic VLAN per VRF to support <strong>L3 VNI</strong></p>
<div class="highlight"><pre><span></span><code>AVD2-LEAF1A#show vlan
VLAN  Name                             Status    Ports
----- -------------------------------- --------- -------------------------------
1     default                          active    Et6, Et7, Et8, PEt6, PEt7, PEt8
110   PR01-DMZ                         active    Cpu, Po3, Po5, Vx1
112   PR02-DMZ-ORANGE                  active    Cpu, Po3, Vx1
201   B-ELAN-201                       active    Po3, Po5, Vx1
1008* VLAN1008                         active    Cpu, Po3, Vx1
1009* VLAN1009                         active    Cpu, Po3, Vx1
3010  MLAG_iBGP_TENANT_A_PROJECT01     active    Cpu, Po3
3011  MLAG_iBGP_TENANT_A_PROJECT02     active    Cpu, Po3
4093  LEAF_PEER_L3                     active    Cpu, Po3
4094  MLAG_PEER                        active    Cpu, Po3

* indicates a Dynamic VLAN


AVD2-LEAF1A#show vxlan vni
VNI to VLAN Mapping for Vxlan1
VNI         VLAN        Source       Interface           802.1Q Tag
----------- ----------- ------------ ------------------- ----------
11          1008*       evpn         Vxlan1              1008
12          1009*       evpn         Vxlan1              1009
10110       110         static       Port-Channel5       110
                                     Vxlan1              110
10112       112         static       Vxlan1              112
20201       201         static       Port-Channel5       201
                                     Vxlan1              201
</code></pre></div>

<p>In <code>TENANT_A_PROJECT02</code>, we can also see an optional feature named <strong><code>vtep_diagnostic</code></strong>. This option allows you to create a loopback in this VRF and do some connectivity test.</p>
<h3 id="configure-downlinks">Configure downlinks<a class="headerlink" href="#configure-downlinks" title="Permanent link">&para;</a></h3>
<p>As we have configured L3LS fabric, EVPN/VXLAN overlay, services, it is now time to configure ports to connect servers. Ports should be configured in <a href="https://github.com/inetsix/demo-avd-evpn-eve-ng/blob/3a461e0ce25afb25d4e51f620bafd324018c1189/inventories/inetsix-eapi/group_vars/AVD2_SERVERS.yml"><code>AVD2_SERVERS.yml</code></a>.</p>
<p>You first have to configure port profile. it is basically a description of how the port will be configured (<code>access</code> or <code>trunk</code>) and which set of vlan(s) will be configured</p>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">port_profiles</span><span class="p">:</span>
  <span class="nt">TENANT_A_B</span><span class="p">:</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">trunk</span>
    <span class="nt">vlans</span><span class="p">:</span> <span class="s">&quot;110-111,201&quot;</span>
  <span class="nt">A-PR01-DMZ</span><span class="p">:</span>
    <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">access</span>
    <span class="nt">vlans</span><span class="p">:</span> <span class="s">&quot;110&quot;</span>
</code></pre></div>

<blockquote>
<p>This section uses vlan-id so all of these entries must be configured in <a href="#configure-vnivlan-across-the-fabric"><strong>TENANTS</strong></a> file</p>
</blockquote>
<p>Then, create port mapping on a per server.</p>
<h4 id="single-home-server">Single home server<a class="headerlink" href="#single-home-server" title="Permanent link">&para;</a></h4>
<p>If server is connected to only one leaf to the fabric, following template can be used</p>
<div class="highlight"><pre><span></span><code><span class="nt">servers</span><span class="p">:</span>
  <span class="nt">A-PR01-DMZ-POD01</span><span class="p">:</span>     <span class="c1"># Server name</span>
    <span class="nt">rack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">POD01</span>         <span class="c1"># Informational RACK</span>
    <span class="nt">adapters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nic</span>
        <span class="nt">server_ports</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Eth0</span><span class="p p-Indicator">]</span>        <span class="c1"># Server port to connect</span>
        <span class="nt">switch_ports</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Ethernet3</span><span class="p p-Indicator">]</span>   <span class="c1"># Switch port to connect server</span>
        <span class="nt">switches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">DC1-AGG01</span><span class="p p-Indicator">]</span>       <span class="c1"># Switch to connect server</span>
        <span class="nt">profile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">A-PR01-DMZ</span>         <span class="c1"># Port profile to apply</span>
</code></pre></div>

<p>Whereas most of the information are purely optional as not used by AVD, the last 3 entries are required:</p>
<ul>
<li><code>switch_ports</code>: Will be used to configure correct port on the switch.</li>
<li><code>switches</code>: Must be switch name defined in your inventory.</li>
<li><code>profile</code>: Profile created previously.</li>
</ul>
<h4 id="server-connected-to-mlag">Server connected to MLAG<a class="headerlink" href="#server-connected-to-mlag" title="Permanent link">&para;</a></h4>
<p>In case of connection to MLAG, data structure is the same and only difference is we need to add information about Port-Channel to configure.</p>
<div class="highlight"><pre><span></span><code><span class="nt">servers</span><span class="p">:</span>
  <span class="nt">DCI_RTR01</span><span class="p">:</span>
    <span class="nt">rack</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DCI</span>
    <span class="nt">adapters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">server_ports</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Eth1</span><span class="p p-Indicator">,</span> <span class="nv">Eth2</span><span class="p p-Indicator">]</span>
        <span class="nt">switch_ports</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">Ethernet5</span><span class="p p-Indicator">,</span> <span class="nv">Ethernet5</span> <span class="p p-Indicator">]</span>
        <span class="nt">switches</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">SITE01-BL01A</span><span class="p p-Indicator">,</span> <span class="nv">SITE01-BL01B</span><span class="p p-Indicator">]</span>
        <span class="nt">profile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">A-PR01-DMZ</span>
        <span class="nt">port_channel</span><span class="p">:</span>
          <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
          <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PortChannel5</span>
          <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">active</span>
</code></pre></div>

<h2 id="configure-tasks-for-avd">Configure tasks for AVD<a class="headerlink" href="#configure-tasks-for-avd" title="Permanent link">&para;</a></h2>
<p>We will now configure AVD tasks you may use in your playbook:</p>
<h3 id="create-directory-structure">Create directory structure<a class="headerlink" href="#create-directory-structure" title="Permanent link">&para;</a></h3>
<p>AVD comes with a role to <a href="https://github.com/aristanetworks/ansible-avd/tree/devel/ansible_collections/arista/avd/roles/build_output_folders">generate your folder structure</a>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build local folders</span>
      <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">build</span><span class="p p-Indicator">]</span>
      <span class="nt">import_role</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">arista.avd.build_output_folders</span>
      <span class="nt">vars</span><span class="p">:</span>
        <span class="nt">fabric_dir_name</span><span class="p">:</span> <span class="s">&#39;{{fabric_name}}&#39;</span>
</code></pre></div>

<h3 id="transform-evpn-datamodel-to-device-data-model">Transform EVPN datamodel to device data model<a class="headerlink" href="#transform-evpn-datamodel-to-device-data-model" title="Permanent link">&para;</a></h3>
<p>AVD provides role <a href="https://github.com/aristanetworks/ansible-avd/blob/devel/ansible_collections/arista/avd/roles/eos_l3ls_evpn/README.md"><strong><code>eos_l3ls_evpn</code></strong></a> role to generate intend YAML device configuration:</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generate intend variables</span>
      <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">build</span><span class="p p-Indicator">]</span>
      <span class="nt">import_role</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">arista.avd.eos_l3ls_evpn</span>
</code></pre></div>

<h3 id="generate-device-configuration-and-documentation">Generate device configuration and documentation<a class="headerlink" href="#generate-device-configuration-and-documentation" title="Permanent link">&para;</a></h3>
<p>After device data have been generated, AVD can build EOS configuration as well as documentation in markdown format.</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">tasks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generate device intended config and documention</span>
      <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">build</span><span class="p p-Indicator">]</span>
      <span class="nt">import_role</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">eos_cli_config_gen</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../yaml-jinja/" title="YAML Structures in Jinja2" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                YAML Structures in Jinja2
              </div>
            </div>
          </a>
        
        
          <a href="../ansible-avd-eve/" title="Arista AVD on EVE-NG" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Arista AVD on EVE-NG
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["instant"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>